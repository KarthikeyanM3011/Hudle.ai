<%- include('layout', { body: `
    <div class="container py-4">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-robot me-2"></i>
                            <%= mode === 'edit' ? 'Edit AI Coach' : 'Create AI Coach' %>
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="coachForm" action="<%= mode === 'edit' ? '/coaches/' + coach.id + '?_method=PUT' : '/coaches' %>" method="POST">
                            <!-- Basic Information -->
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">Basic Information</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Coach Name *</label>
                                            <input type="text" class="form-control" id="name" name="name" 
                                                   value="<%= mode === 'edit' ? coach.name : '' %>" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="creationType" class="form-label">Creation Type</label>
                                            <select class="form-select" id="creationType" name="creationType">
                                                <option value="custom" <%= mode === 'edit' && coach.creationType === 'custom' ? 'selected' : '' %>>Custom Coach</option>
                                                <option value="guided" <%= mode === 'edit' && coach.creationType === 'guided' ? 'selected' : '' %>>Guided Creation</option>
                                                <option value="template" <%= mode === 'edit' && coach.creationType === 'template' ? 'selected' : '' %>>From Template</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" 
                                              placeholder="Describe what this coach specializes in and how it helps users..."><%= mode === 'edit' ? coach.description : '' %></textarea>
                                </div>
                            </div>
    
                            <!-- Personality Configuration -->
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">Personality Traits</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="extraversion" class="form-label">Extraversion (1-10)</label>
                                            <input type="range" class="form-range" id="extraversion" name="personality[traits][extraversion]" 
                                                   min="1" max="10" value="<%= mode === 'edit' ? (coach.personality?.traits?.extraversion || 5) : 5 %>">
                                            <div class="d-flex justify-content-between">
                                                <small>Introverted</small>
                                                <small id="extraversionValue">5</small>
                                                <small>Extroverted</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="empathy" class="form-label">Empathy (1-10)</label>
                                            <input type="range" class="form-range" id="empathy" name="personality[traits][empathy]" 
                                                   min="1" max="10" value="<%= mode === 'edit' ? (coach.personality?.traits?.empathy || 7) : 7 %>">
                                            <div class="d-flex justify-content-between">
                                                <small>Analytical</small>
                                                <small id="empathyValue">7</small>
                                                <small>Empathetic</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="directness" class="form-label">Directness (1-10)</label>
                                            <input type="range" class="form-range" id="directness" name="personality[traits][directness]" 
                                                   min="1" max="10" value="<%= mode === 'edit' ? (coach.personality?.traits?.directness || 6) : 6 %>">
                                            <div class="d-flex justify-content-between">
                                                <small>Gentle</small>
                                                <small id="directnessValue">6</small>
                                                <small>Direct</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="patience" class="form-label">Patience (1-10)</label>
                                            <input type="range" class="form-range" id="patience" name="personality[traits][patience]" 
                                                   min="1" max="10" value="<%= mode === 'edit' ? (coach.personality?.traits?.patience || 7) : 7 %>">
                                            <div class="d-flex justify-content-between">
                                                <small>Quick</small>
                                                <small id="patienceValue">7</small>
                                                <small>Patient</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="communicationStyle" class="form-label">Communication Style</label>
                                            <select class="form-select" id="communicationStyle" name="personality[communicationStyle]">
                                                <option value="formal" <%= mode === 'edit' && coach.personality?.communicationStyle === 'formal' ? 'selected' : '' %>>Formal</option>
                                                <option value="casual" <%= mode === 'edit' && coach.personality?.communicationStyle === 'casual' ? 'selected' : '' %>>Casual</option>
                                                <option value="encouraging" <%= mode === 'edit' && coach.personality?.communicationStyle === 'encouraging' ? 'selected' : '' %>>Encouraging</option>
                                                <option value="challenging" <%= mode === 'edit' && coach.personality?.communicationStyle === 'challenging' ? 'selected' : '' %>>Challenging</option>
                                                <option value="supportive" <%= mode === 'edit' && coach.personality?.communicationStyle === 'supportive' ? 'selected' : '' %>>Supportive</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="approachMethod" class="form-label">Coaching Approach</label>
                                            <select class="form-select" id="approachMethod" name="personality[approachMethod]">
                                                <option value="socratic" <%= mode === 'edit' && coach.personality?.approachMethod === 'socratic' ? 'selected' : '' %>>Socratic Questioning</option>
                                                <option value="direct" <%= mode === 'edit' && coach.personality?.approachMethod === 'direct' ? 'selected' : '' %>>Direct Instruction</option>
                                                <option value="supportive" <%= mode === 'edit' && coach.personality?.approachMethod === 'supportive' ? 'selected' : '' %>>Supportive Guidance</option>
                                                <option value="goal-oriented" <%= mode === 'edit' && coach.personality?.approachMethod === 'goal-oriented' ? 'selected' : '' %>>Goal-Oriented</option>
                                                <option value="exploratory" <%= mode === 'edit' && coach.personality?.approachMethod === 'exploratory' ? 'selected' : '' %>>Exploratory</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Expertise Configuration -->
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">Expertise & Knowledge</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="primaryDomain" class="form-label">Primary Domain *</label>
                                            <select class="form-select" id="primaryDomain" name="expertise[primaryDomain]" required>
                                                <option value="">Select a domain...</option>
                                                <option value="interview" <%= mode === 'edit' && coach.expertise?.primaryDomain === 'interview' ? 'selected' : '' %>>Interview Coaching</option>
                                                <option value="sales" <%= mode === 'edit' && coach.expertise?.primaryDomain === 'sales' ? 'selected' : '' %>>Sales Training</option>
                                                <option value="language" <%= mode === 'edit' && coach.expertise?.primaryDomain === 'language' ? 'selected' : '' %>>Language Learning</option>
                                                <option value="career" <%= mode === 'edit' && coach.expertise?.primaryDomain === 'career' ? 'selected' : '' %>>Career Development</option>
                                                <option value="presentation" <%= mode === 'edit' && coach.expertise?.primaryDomain === 'presentation' ? 'selected' : '' %>>Presentation Skills</option>
                                                <option value="leadership" <%= mode === 'edit' && coach.expertise?.primaryDomain === 'leadership' ? 'selected' : '' %>>Leadership</option>
                                                <option value="custom" <%= mode === 'edit' && coach.expertise?.primaryDomain === 'custom' ? 'selected' : '' %>>Custom Domain</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="experienceLevel" class="form-label">Experience Level</label>
                                            <select class="form-select" id="experienceLevel" name="expertise[experienceLevel]">
                                                <option value="beginner" <%= mode === 'edit' && coach.expertise?.experienceLevel === 'beginner' ? 'selected' : '' %>>Beginner</option>
                                                <option value="intermediate" <%= mode === 'edit' && coach.expertise?.experienceLevel === 'intermediate' ? 'selected' : '' %>>Intermediate</option>
                                                <option value="expert" <%= mode === 'edit' && coach.expertise?.experienceLevel === 'expert' ? 'selected' : '' %>>Expert</option>
                                                <option value="master" <%= mode === 'edit' && coach.expertise?.experienceLevel === 'master' ? 'selected' : '' %>>Master</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="specializations" class="form-label">Specializations</label>
                                    <input type="text" class="form-control" id="specializations" name="expertise[specializations]" 
                                           placeholder="e.g., behavioral interviews, technical interviews, salary negotiation"
                                           value="<%= mode === 'edit' && coach.expertise?.specializations ? coach.expertise.specializations.join(', ') : '' %>">
                                    <div class="form-text">Separate multiple specializations with commas</div>
                                </div>
                            </div>
    
                            <!-- Appearance Configuration -->
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">Appearance & Voice</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Choose Avatar</label>
                                            <div class="avatar-grid">
                                                <% if (avatars && avatars.length > 0) { %>
                                                    <% avatars.forEach((avatar, index) => { %>
                                                        <div class="avatar-option">
                                                            <input type="radio" class="btn-check" name="appearance[avatarId]" 
                                                                   id="avatar<%= index %>" value="<%= avatar.id %>"
                                                                   <%= mode === 'edit' && coach.appearance?.avatarId == avatar.id ? 'checked' : index === 0 ? 'checked' : '' %>>
                                                            <label class="btn btn-outline-primary avatar-label" for="avatar<%= index %>">
                                                                <img src="<%= avatar.url %>" alt="<%= avatar.originalName %>" class="avatar-img">
                                                            </label>
                                                        </div>
                                                    <% }); %>
                                                <% } else { %>
                                                    <p class="text-muted">No avatars available</p>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="voiceId" class="form-label">Voice Selection</label>
                                            <select class="form-select" id="voiceId" name="voice[voiceId]">
                                                <option value="default-professional-male">Professional Male</option>
                                                <option value="default-professional-female">Professional Female</option>
                                                <option value="default-friendly-male">Friendly Male</option>
                                                <option value="default-supportive-female">Supportive Female</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="voiceStability" class="form-label">Voice Stability</label>
                                            <input type="range" class="form-range" id="voiceStability" name="voice[stability]" 
                                                   min="0" max="1" step="0.1" value="<%= mode === 'edit' ? (coach.voice?.stability || 0.5) : 0.5 %>">
                                            <div class="d-flex justify-content-between">
                                                <small>Variable</small>
                                                <small id="stabilityValue">0.5</small>
                                                <small>Stable</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Sharing Settings -->
                            <div class="mb-4">
                                <h5 class="fw-bold mb-3">Sharing Settings</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isPublic" name="sharing[isPublic]"
                                                   <%= mode === 'edit' && coach.sharing?.isPublic ? 'checked' : '' %>>
                                            <label class="form-check-label" for="isPublic">
                                                Make this coach public
                                            </label>
                                            <div class="form-text">Allow other users to discover and use this coach</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isTemplate" name="sharing[isTemplate]"
                                                   <%= mode === 'edit' && coach.sharing?.isTemplate ? 'checked' : '' %>>
                                            <label class="form-check-label" for="isTemplate">
                                                Add to template marketplace
                                            </label>
                                            <div class="form-text">Share as a template for others to customize</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Form Actions -->
                            <div class="d-flex justify-content-between">
                                <a href="/coaches" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Cancel
                                </a>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="previewCoach()">
                                        <i class="fas fa-eye me-2"></i>Preview
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>
                                        <%= mode === 'edit' ? 'Update Coach' : 'Create Coach' %>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
    .avatar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
    }
    
    .avatar-option {
        text-align: center;
    }
    
    .avatar-label {
        width: 80px;
        height: 80px;
        padding: 5px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .avatar-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 50%;
    }
    
    .btn-check:checked + .avatar-label {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
    </style>
    
    <script>
    // Update range slider values
    document.querySelectorAll('input[type="range"]').forEach(slider => {
        const valueSpan = document.getElementById(slider.id + 'Value');
        if (valueSpan) {
            valueSpan.textContent = slider.value;
            slider.addEventListener('input', () => {
                valueSpan.textContent = slider.value;
            });
        }
    });
    
    // Form submission handling
    document.getElementById('coachForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Process specializations
        const specializationsInput = document.getElementById('specializations');
        if (specializationsInput.value) {
            const specializations = specializationsInput.value.split(',').map(s => s.trim());
            specializationsInput.value = JSON.stringify(specializations);
        }
        
        this.submit();
    });
    
    function previewCoach() {
        const formData = new FormData(document.getElementById('coachForm'));
        const coachData = {};
        
        for (let [key, value] of formData.entries()) {
            coachData[key] = value;
        }
        
        // Simple preview modal or redirect
        alert('Preview functionality would show how the coach will behave based on current settings');
    }
    </script>
    `}) %>